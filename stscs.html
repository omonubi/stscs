<!-- General Information -->
<div class="divGeneralInfo">
    <table>
        <tr>            
            <td class="label">Class/Model:</td>
            <td><input type="text" name="attr_shipClass" style="width:100%;"/></td>            
            <td class="label">Faction:</td>
            <td>
                <select name="attr_shipFaction">
                    <option value="(undefined)">select...</option>
                    <option value="UFP">Federation</option>
                    <option value="KE">Klingon</option>
                    <option value="RSE">Romulan</option>
                    <option value="GA">Gorn</option>
                    <option value="OC">Orion</option>
                </select>
            </td>
        </tr>
        <tr>
            <td class="label">Superstructure: </td>
            <td>
                <input class="current" name="attr_sup" type="number"  min="0" max="200" value="0"/> out of
                <input name="attr_sup_max" type="number" min="1" max="200" value="1"/>
            </td>
            <td class="label">Damage Chart:</td>
            <td>
                <select name="attr_damageChart">
                    <option value="0">select...</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                </select>
            </td>
        </tr>
        <tr>
            <td colspan="3"></td>
            <td>
                <button type="roll" value="Identifying @{character_name}, moving at a speed of [[floor(@{pwr2Move} * @{mpr2} / @{mpr1})]]."> Identify</button>
            </td>
        </tr>
    </table>
</div>

<!-- Engines and Movement -->
<div class="divEngines">
    <table class="header">
        <tr>
            <td>----- Engines and Movement -----</td>
        </tr>
    </table>
    <table>
        <tr>
            <td class="label">Port Warp Engine:</td>
            <td>
                <input class="current" name="attr_pwrSource1" type="number" min="0" max="50"/> out of
                <input name="attr_pwrSource1_max" type="number" min="1" max="50" value="0"/>
            </td>
            <td class="label">Max Safe Warp:</td>
            <td colspan="3">
                <input type="number" min="0" max="14" name="attr_warpMSCS" value="0"/> on SC:
                <select name="attr_warpMSCSStress">
                    <option value="0">n/a</option>
                    <option value="a">A</option>
                    <option value="b">B</option>
                    <option value="c">C</option>
                    <option value="d">D</option>
                    <option value="e">E</option>
                    <option value="f">F</option>
                    <option value="g">G</option>
                    <option value="h">H</option>
                    <option value="i">I</option>
                    <option value="j">J</option>
                    <option value="k">K</option>
                    <option value="l">L</option>
                    <option value="m">M</option>
                    <option value="n">N</option>
                    <option value="o">O</option>
                    <option value="p">P</option>
                    <option value="q">Q</option>
                    <option value="r">R</option>
                </select>
            </td>
        </tr>
        <tr>
            <td class="label">Starboard Warp Engine:</td>
            <td>
                <input class="current" name="attr_pwrSource2" type="number" min="0" max="50" value="0"/> out of
                <input name="attr_pwrSource2_max" type="number" min="1" max="50" value="0"/>
            </td>
            <td class="label">Max Emergency Warp:</td>
            <td colspan="3">
                <input type="number" min="0" max="14" name="attr_warpEmergency" value="0"/> on SC:
                <select name="attr_warpEmergencyStress">
                    <option value="0">n/a</option>
                    <option value="a">A</option>
                    <option value="b">B</option>
                    <option value="c">C</option>
                    <option value="d">D</option>
                    <option value="e">E</option>
                    <option value="f">F</option>
                    <option value="g">G</option>
                    <option value="h">H</option>
                    <option value="i">I</option>
                    <option value="j">J</option>
                    <option value="k">K</option>
                    <option value="l">L</option>
                    <option value="m">M</option>
                    <option value="n">N</option>
                    <option value="o">O</option>
                    <option value="p">P</option>
                    <option value="q">Q</option>
                    <option value="r">R</option>
                </select>
            </td>
        </tr>
        <tr>
            <td class="label">Impulse Engine:</td>
            <td>
                <input class="current" name="attr_pwrSource3" type="number" min="0" max="50" value="0"/> out of
                <input name="attr_pwrSource3_max" type="number" min="1" max="50" value="0"/>
            </td>
            <td class="label">Movement Point Ratio:</td>
            <td colspan="3"><input type="number" min="1" max="6" name="attr_mpr1" value="1"/> / <input type="number" min="1" max="6" name="attr_mpr2" value="1"/></td>
        </tr>
        <tr>
            <td class="labelBold">Total Power Currently Available:</td>
            <td>
                <input class="current" name="attr_pwrTotal" type="number" readonly="true">
            </td>
            <td class="labelBold">Current Movement:</td>
            <td colspan="3">
                <input class="movement" type="number" name="attr_mp_max_copy" value="@{mp_max}" disabled="true"/>
                - <input class="current" type="number" min="0" name="attr_mp_used" value="0"/>
                = <input class="current" type="number" name="attr_mp_now" value="(@{mp_max_copy} - @{mp_used})" disabled="true"/>
            </td>
        </tr>
    </table>
</div>

<!-- Power Allocation -->
<div class="divAllocation">
    <table class="header">
        <tr>
            <td>----- Power Allocation -----</td>
        </tr>
    </table>
    <table>
        <tr>
            <td class="label">Power to Movement:</td>
            <td><input class="movement" type="number" min="0" max="80" value="0" name="attr_pwr2Move"/></td>
            <td class="label">Power to Shields:</td>
            <td><input class="shields" type="number" min="0" max="80" value="0" name="attr_pwr2Shields"/></td>
            <td class="label">Power to Weapons:</td>
            <td><input class="weapons" type="number" name="attr_pwr2Weapons01" readonly="true"/></td>
        </tr>
        <tr>
            <td class="label">Movement Points Available:</td>
            <td><input class="movement" type="number" name="attr_mp_max" value="floor(@{pwr2Move} * @{mpr2} / @{mpr1})" disabled="true"/></td>
            <td class="label">Shield Points Available:</td>
            <td><input class="shields" type="number" name="attr_sp_max" value="floor(@{pwr2Shields} * @{spr2} / @{spr1})" disabled="true"/></td>
            <td class="label">Current Turn:</td>
            <td><input type="number" min="0" value="0" name="attr_currentTurn"/></td>
        </tr>
    </table>
</div>

<!-- Shield Data -->
<div class="divShields">
    <table class="header">
        <tr>
            <td>----- Shield Data -----</td>
        </tr>
    </table>
    <table>
        <tr>
            <td class="label">Maximum Shield Power:</td>
            <td><input type="number" min="0" max="20" value="1" name="attr_shieldsMax"/></td>
            <td class="label">Shield Point Ratio:</td>
            <td><input type="number" min="1" max="2" name="attr_spr1" value="1"/> / <input type="number" min="1" max="4" name="attr_spr2" value="1"/></td>
        </tr>
        <tr>
            <td class="label">FP:</td>
            <td colspan="3">
                <input class="shields" type="number" min="0" max="20" value="0" name="attr_shieldFP"/>
                - <input class="current" type="number" min="0" max="20" value="0" name="attr_shieldFP_dmg"/>
                = <input class="current" type="number" name="attr_shieldFP_now" value="@{shieldFP} - @{shieldFP_dmg}" disabled="true"/>
                | <input type="checkbox" name="attr_shieldFPDamaged"/> damaged
            </td>
        </tr>
        <tr>
            <td class="label">Fwd:</td>
            <td colspan="3">
                <input class="shields" type="number" min="0" max="20" value="0" name="attr_shieldFwd"/>
                - <input class="current" type="number" min="0" max="20" value="0" name="attr_shieldFwd_dmg"/>
                = <input class="current" type="number" name="attr_shieldFwd_now" value="@{shieldFwd} - @{shieldFwd_dmg}" disabled="true"/>
                | <input type="checkbox" name="attr_shieldFwdDamaged"/> damaged
            </td>
        </tr>
        <tr>
            <td class="label">FS:</td>
            <td colspan="3">
                <input class="shields" type="number" min="0" max="20" value="0" name="attr_shieldFS"/>
                - <input class="current" type="number" min="0" max="20" value="0" name="attr_shieldFS_dmg"/>
                = <input class="current" type="number" name="attr_shieldFS_now" value="@{shieldFS} - @{shieldFS_dmg}" disabled="true"/>
                | <input type="checkbox" name="attr_shieldFSDamaged"/> damaged
            </td>
        </tr>
        <tr>
            <td class="label">AP:</td>
            <td colspan="3">
                <input class="shields" type="number" min="0" max="20" value="0" name="attr_shieldAP"/>
                - <input class="current" type="number" min="0" max="20" value="0" name="attr_shieldAP_dmg"/>
                = <input class="current" type="number" name="attr_shieldAP_now" value="@{shieldAP} - @{shieldAP_dmg}" disabled="true"/>
                | <input type="checkbox" name="attr_shieldAPDamaged"/> damaged
            </td>
        </tr>
        <tr>
            <td class="label">Aft:</td>
            <td colspan="3">
                <input class="shields" type="number" min="0" max="20" value="0" name="attr_shieldAft"/>
                - <input class="current" type="number" min="0" max="20" value="0" name="attr_shieldAft_dmg"/>
                = <input class="current" type="number" name="attr_shieldAft_now" value="@{shieldAft} - @{shieldAft_dmg}" disabled="true"/>
                | <input type="checkbox" name="attr_shieldAftDamaged"/> damaged
            </td>
        </tr>
        <tr>
            <td class="label">AS:</td>
            <td colspan="3">
                <input class="shields" type="number" min="0" max="20" value="0" name="attr_shieldAS"/>
                - <input class="current" type="number" min="0" max="20" value="0" name="attr_shieldAS_dmg"/>
                = <input class="current" type="number" name="attr_shieldAS_now" value="@{shieldAS} - @{shieldAS_dmg}" disabled="true"/>
                | <input type="checkbox" name="attr_shieldASDamaged"/> damaged
            </td>
        </tr>
        <tr>
            <td class="label">Shield Points Remaining:</td>
            <td>
                <input class="shields" type="number" name="attr_spTotal" value="@{sp_max} - @{shieldFP} - @{shieldFwd} - @{shieldFS} - @{shieldAP} - @{shieldAft} - @{shieldAS}" disabled="true"/>
            </td>
        </tr>
    </table>
</div>

<!-- Weapons Data -->
<div class="divWeapons">
    <table class="header">
        <tr>
            <td>----- Weapons Data -----</td>
        </tr>
    </table>
    <table>
        <tr>
            <td>
                Weapon Power Available: 
                <input class="weapons" type="number" name="attr_pwr2Weapons02" readonly="true"/> - 
                <input class="current" type="number" name="attr_pwr2WeaponsAllocated" readonly="true"/> = 
                <input class="weapons" type="number" name="attr_pwr2WeaponsRemaining" value="@{pwr2Weapons02} - @{pwr2WeaponsAllocated}" disabled="true"/>
            </td>
        </tr>
    </table>
    <fieldset class="repeating_weapons">
        <table class="tblWeapon">
            <tr>
                <td style="text-align: left; background-color:#bbb;">
                    DMG <input type="checkbox" name="attr_wpnDamaged"/>
                    <select name="attr_wpnType" style="width: 235px;" >
                        <option value="0"></option>
                        <option value="Distruptor">Disruptor</option>
                        <option value="Phaser">Phaser</option>
                        <option value="Plasma">Plasma</option>
                        <option value="Photon Torpedo">Photon Torpedo</option>
                    </select>
                    x <input type="number" min="1" max="4" value="0" name="attr_wpnNum"/>
                    Firing Arcs: <select name="attr_wpnArc">
                        <option value="0"></option>
                        <option value="F">F</option>
                        <option value="FP">FP</option>
                        <option value="FS">FS</option>
                        <option value="P">P</option>
                        <option value="S">S</option>
                        <option value="A">A</option>
                        <option value="AP">AP</option>
                        <option value="AS">AS</option>
                        <option value="FPS">FPS</option>
                        <option value="APS">APS</option>
                        <option value="FPA">FPA</option>
                        <option value="FSA">FSA</option>
                    </select>
                    Firing Chart: <select name="attr_wpnChart">
                        <option value="0"></option>
                        <option value="a">A</option>
                        <option value="b">B</option>
                        <option value="c">C</option>
                        <option value="d">D</option>
                        <option value="e">E</option>
                        <option value="f">F</option>
                        <option value="g">G</option>
                        <option value="h">H</option>
                        <option value="i">I</option>
                        <option value="j">J</option>
                        <option value="k">K</option>
                        <option value="l">L</option>
                        <option value="m">M</option>
                        <option value="n">N</option>
                        <option value="o">O</option>
                        <option value="p">P</option>
                        <option value="q">Q</option>
                        <option value="r">R</option>
                        <option value="s">S</option>
                        <option value="t">T</option>
                        <option value="u">U</option>
                        <option value="v">V</option>
                        <option value="w">W</option>
                        <option value="x">X</option>
                        <option value="y">Y</option>
                    </select>
                    Maximum Range: <input type="number" min="1" max="24" value="1" name="attr_wpnRange"/>
                </td>
            </tr><tr>
                <td style="text-align: left; background-color:#bbb;">
                    Current Charge: <input class="weapons" type="number" min="0" max="20" name="attr_wpnCharge" value="0"/>
                    Maximum: <input type="number" min="1" name="attr_wpnChargeMax" value="1"/>
                    Damage Modifiers: <input class="wpnModifiers" type="text" name="attr_wpnMods"/>
                    Fired <input type="checkbox" name="attr_wpnFired"/>
                    <button type="roll" value="/roll 1d10<?{Required To-Hit} @{character_name} is firing @{wpnType} x@{wpnNum} at @{wpnCharge} power with the following damage modifiers: @{wpnMods}..."></button>
                </td>
            </tr>
        </table>
    </fieldset>
</div>

<script type="text/worker">

    on("change:pwrSource1 change:pwrSource2 change:pwrSource3 change:pwr2Move change:pwr2Shields", function(eventInfo) {
        updatePowerInfo();
    });
    
    on("change:repeating_weapons:wpnCharge change:repeating_weapons:wpnNum", function(eventInfo) {
        updateWeaponsInfo();
    });
    
    on("remove:repeating_weapons", function(eventInfo) {
         updateWeaponsInfo();
    });
    
    on("change:currentTurn", function(eventInfo) {
        resetForm();
    });
    
    var resetForm = function() {
        setAttrs({
            "mp_used": 0,
            "pwr2Move": 0,
            "shieldFP_dmg": 0,
            "shieldFwd_dmg": 0,
            "shieldFS_dmg": 0,
            "shieldAP_dmg": 0,
            "shieldAft_dmg": 0,
            "shieldAS_dmg": 0
        });
        getSectionIDs("repeating_weapons", function(idarray) {
            for(var i=0; i < idarray.length; i++) {
                var attrs = {};
                attrs['repeating_weapons_' + idarray[i] + '_wpnCharge'] = idarray[i];
                setAttrs(attrs);
            }          
        });        
    };
    
    var updatePowerInfo = function() {
        getAttrs(["pwrSource1", "pwrSource2", "pwrSource3", "pwrTotal", "pwr2Move", "pwr2Shields"], function(vals) {
            var totalPowerAvailable 
                = parseInt(vals["pwrSource1"], 10)
                + parseInt(vals["pwrSource2"], 10)
                + parseInt(vals["pwrSource3"], 10);
            var powerToWeapons 
                = totalPowerAvailable
                - parseInt(vals["pwr2Move"], 10)
                - parseInt(vals["pwr2Shields"], 10);
            setAttrs({
                    "pwrTotal" : totalPowerAvailable,
                    "pwr2Weapons01": powerToWeapons,
                    "pwr2Weapons02": powerToWeapons
            });
        });
    };
    
    var updateWeaponsInfo = function() {
        getSectionIDs(["repeating_weapons"], function(idarray) {
            var weaponChargeArray = idarray.map(function(rowID) { return 'repeating_weapons_' + rowID + '_wpnCharge'; });
            var weaponNumArray = idarray.map(function(rowID) { return 'repeating_weapons_' + rowID + '_wpnNum'; });
            var weaponArray = weaponChargeArray.concat(weaponNumArray);
            getAttrs(weaponArray, function(values) {
                var total = i = 0;
                for(; i < weaponArray.length/2; i++) {
                    var subtotal = parseInt(values[weaponArray[i]] || 0) * parseInt(values[weaponArray[i + weaponArray.length/2]] || 0)
                    total += subtotal;
                }
                setAttrs({ 'pwr2WeaponsAllocated': total });
            })
        });
    };

</script>