<div>
    <h1><span name='attr_character_name'></span></h1> 
    <!-------------------------------------------------------->
    <div class='grid-3col'>
        <span>
            <span name='attr_class'></span>
            <span name='attr_type'></span>
        </span>
        <span>
            <label>Size:</label>
            <span name='attr_size'></span>
        </span>
        <span>
            <label>D / WDF / CE:</label>
            <input type='number' class='w5' name='attr_defense' min='0' step='.1' value='0'/>
            /
            <input type='number' class='w5' name='attr_wdf' min='0' step='.1' value='0'/>
            /
            <span name='attr_ce'>0</span>
        </span>
    </div>
    <hr/>

    <!-------------------------------------------------------->
    <h2>Damage Control</h2>

    <div class='grid-3col'>
        <span>
            <label>Hull Points:</label>
            <input type='hidden' class='hp-status' name='attr_hp_status' value='0'/>
            <input type='number' class='hp' name='attr_hp' min='0' value='0'/> / <span name='attr_hp_max'></span>
        </span>

        <span>
            <label>Crew:</label>
            <span >
                <input type='number' class='w5' name='attr_crew' value='0' min='0'/>
                /
                <span name='attr_crew_max'></span>
            </span>
        </span>
        <span>
            <label>Damage Chart:</label>
            <span name='attr_dmg_chart'></span>
        </span>

    <h4 class='span-grid'>Engines</h4>
    <fieldset class='repeating_engines'>
        <input type='text' class='w10' name='attr_engine_model' placeholder='Model...' title='model'/>
        <select class='w10' name='attr_engine_type'>
            <option value='0' selected>Type...</option>
            <option value='1'>Impulse</option>
            <option value='2'>Warp</option>
        </select>
        <select class='w10' name='attr_engine_location'>
            <option value='0' selected>Location...</option>
            <option value='1'>Centerline</option>
            <option value='2'>Port</option>
            <option value='3'>Starboard</option>
        </select>
        Power: 
        <input type='hidden' class='engine-power-status' name='attr_engine_power_status' value='0'/>
        <input type='number' class='engine-power' name='attr_engine_power' min='0' value='0'/> / <input type='number' name='attr_engine_power_max' min='0' value='0'/>
    </fieldset>
    </div>
    <hr/>

    <!-------------------------------------------------------->
    <h2>Total Power Available</h2>
    <div class='grid-3col'>
        <span>
            <label>TPA:</label> 
            <span name='attr_tpa'></span> / <span name='attr_tpa_max'></span>
        </span>
        <span>
            <button type='action' class='btn' name='act_tpa_reset'>Reset TPA</button>
        </span>
        <span>
            <label>TPA Unallocated:</label>
            <input type='hidden' class='tpa-remaining-status' name='attr_tpa_remaining_status'/>
            <input type='number' class='tpa-remaining' name='attr_tpa_remaining'  value='0' readonly/>
        </span>
        
        <span>
            <label>TPA to Movement:</label>
            <input type='number' class='em' name='attr_tpa_movement' min='0' value='0'/>
        </span>
        <span>
            <label>TPA to Shields:</label>
            <input type='number' class='em' name='attr_tpa_shields' min='0' value='0'/>
        </span>
        <span>
            <label>TPA to Weapons:</label>
            <input type='number' class='em' name='attr_tpa_weapons' min='0' value='0'/>
        </span>
    </div>
    <hr/>

    <!-------------------------------------------------------->
    <h2>Helm Control</h2>
    <div class='grid-3col'>
        <span>
            <label>TPA to Movement:</label>
            <input type='number' class='em' name='attr_tpa_movement' min='0' value='0'/>
        </span>
        <span>
            <label>MP by Phase:</label> 
            <input type='hidden' name='attr_mp'/>
            <input type='hidden' name='attr_ta'/>
            <span name='attr_mp1'></span> | <span name='attr_mp2'></span> | <span name='attr_mp3'></span>
        </span>
        <span>
            <label>TPA Remaining:</label> 
            <input type='hidden' class='mp-remaining-status' name='attr_mp_remaining_status'/>
            <input type='number' class='mp-remaining' name='attr_mp_remaining' value='0' readonly/>
        </span>
        
        <span>
            <label>MPR: </label>
            <input type='number' class='w3' name='attr_mpr_1' min='1' max='6' value='1'/>
            /
            <input type='number' class='w3' name='attr_mpr_2' min='1' max='2' value='1'/>
        </span>
        <span>
            <label>Warp Speeds:</label>
            <input type='number' class='w3' name='attr_warp_1' min='0' value='0'/>
            /
            <input type='number' class='w3' name='attr_warp_2' min='0' value='0'/>
        </span>
        <span>
            <label>Stress Charts:</label>
            <input type='text' class='w3' name='attr_stress_1' maxlength='1'/>
            /            
            <input type='text' class='w3' name='attr_stress_2' maxlength='1'/> 
        </span>
    </div>
    <hr/>

    <!-------------------------------------------------------->
    <h2>Shield Control</h2>
    <div class='grid-3col'>
        <span>
            <label>TPA to Shields:</label>
            <input type='number' class='em' name='attr_tpa_shields' min='0' value='0'/>
        </span>
        <span>
                <label>Shield Points:</label> <span name='attr_sp'></span>
        </span>
        <span>
            <label>TPA Remaining:</label>
            <input type='hidden' class='sp-remaining-status' name='attr_sp_remaining_status'/>
            <input type='number' class='sp-remaining' name='attr_sp_remaining' value='0' readonly/>
        </span>

        <span>
            <label>SPR: </label>
            <input type='number' class='w3' name='attr_spr_1' min='1' max='2' value='1'/>
            /        
            <input type='number' class='w3' name='attr_spr_2' min='1' max='6' value='1'/>
        </span>
        <span>
            <label>Shield Type:</label>
            <input type='text' class='w10' name='attr_shield_type'/>
        </span>
        <span>
            <label>Max Shield Power:</label>
            <input type='number' name='attr_shield_max' min='0' max='16' value='0'/>
        </span> 

        <span class='shields-damaged'>
            <input type='checkbox' class='damaged' name='attr_shield_1_damaged' value='1' title='generator damaged'/>
            <input type='checkbox' class='damaged' name='attr_shield_2_damaged' value='1' title='generator damaged'/>
            <input type='checkbox' class='damaged' name='attr_shield_3_damaged' value='1' title='generator damaged'/>
            <input type='checkbox' class='damaged' name='attr_shield_4_damaged' value='1' title='generator damaged'/>
            <input type='checkbox' class='damaged' name='attr_shield_5_damaged' value='1' title='generator damaged'/>
            <input type='checkbox' class='damaged' name='attr_shield_6_damaged' value='1' title='generator damaged'/>
        </span>
        <span></span>
        
        <input type='hidden' class='shields-allocated-status' name='attr_shields_allocated_status' value='1'/>
        <span class='shields-allocated'>
            <label>f/p:</label>
            <input type='hidden' class='shield-1-status' name='attr_shield_1_status'/>
            <input type='number' class='shield-1' name='attr_shield_1' min='0' max='16' value='0' title='Shield #1 (f/p)'/>
            <label>fwd:</label>
            <input type='hidden' class='shield-2-status' name='attr_shield_2_status'/>
            <input type='number' class='shield-2' name='attr_shield_2' min='0' max='16' value='0' title='Shield #2 (fwd)'/>
            <label>f/s:</label>
            <input type='hidden' class='shield-3-status' name='attr_shield_3_status'/>
            <input type='number' class='shield-3' name='attr_shield_3' min='0' max='16' value='0' title='Shield #3 (f/s)'/>
            <label>a/s:</label>
            <input type='hidden' class='shield-4-status' name='attr_shield_4_status'/>
            <input type='number' class='shield-4' name='attr_shield_4' min='0' max='16' value='0' title='Shield #4 (a/s)'/>
            <label>aft</label>
            <input type='hidden' class='shield-5-status' name='attr_shield_5_status'/>
            <input type='number' class='shield-5' name='attr_shield_5' min='0' max='16' value='0' title='Shield #5 (aft)'/>
            <label>a/p:</label>
            <input type='hidden' class='shield-6-status' name='attr_shield_6_status'/>
            <input type='number' class='shield-6' name='attr_shield_6' min='0' max='16' value='0' title='Shield #6 (a/p)'/>
        </span>
        <input type='hidden' class='shields-allocated-status' name='attr_shields_allocated_status' value='1'/>
        <span class='shields-allocated-buttons'>
            <button type='action' class='btn' name='act_shield_commit'>Commit TPA</button>
        </span>

        <input type='hidden' class='shields-current-status' name='attr_shields_current_status' value='0'/>
        <span class='shields-current'>
            <label>f/p:</label>
            <input type='hidden' class='shield-1c-status' name='attr_shield_1c_status'/>
            <input type='number' class='shield-1c' name='attr_shield_1c' min='0' max='16' value='0' title='Shield #1 (f/p)'/>
            <label>fwd:</label>
            <input type='hidden' class='shield-2c-status' name='attr_shield_2c_status'/>
            <input type='number' class='shield-2c' name='attr_shield_2c' min='0' max='16' value='0' title='Shield #2 (fwd)'/>
            <label>f/s:</label>
            <input type='hidden' class='shield-3c-status' name='attr_shield_3c_status'/>
            <input type='number' class='shield-3c' name='attr_shield_3c' min='0' max='16' value='0' title='Shield #3 (f/s)'/>
            <label>a/s:</label>
            <input type='hidden' class='shield-4c-status' name='attr_shield_4c_status'/>
            <input type='number' class='shield-4c' name='attr_shield_4c' min='0' max='16' value='0' title='Shield #4 (a/s)'/>
            <label>aft</label>
            <input type='hidden' class='shield-5c-status' name='attr_shield_5c_status'/>
            <input type='number' class='shield-5c' name='attr_shield_5c' min='0' max='16' value='0' title='Shield #5 (aft)'/>
            <label>a/p:</label>
            <input type='hidden' class='shield-6c-status' name='attr_shield_6c_status'/>
            <input type='number' class='shield-6c' name='attr_shield_6c' min='0' max='16' value='0' title='Shield #6 (a/p)'/>
        </span>
        <input type='hidden' class='shields-current-status' name='attr_shields_current_status' value='0'/>
        <span class='shields-current-buttons'>
            <button type='action' class='btn' name='act_shield_reenergize'>Re-Energize</button>
        </span>
    </div>
    <hr/>

    <!-------------------------------------------------------->
    <h2>Fire Control</h2>
    <div class='grid-3col'>
        <span>
            <label>TPA to Weapons:</label>
            <input type='number' class='em' name='attr_tpa_weapons' min='0' value='0'/>
        </span>
        <span></span>
        <span>
            <label>TPA Remaining:</label>
            <input type='hidden' class='wp-remaining-status' name='attr_wp_remaining_status'/>
            <input type='number' class='wp-remaining' name='attr_wp_remaining' value='0' readonly/>
        </span>

    <h4 class='span-grid'>Beam Weapons</h4>
    <fieldset class='repeating_beams'>
        <input type='checkbox' class='targeted' name='attr_beam_targeted' value='1' title='weapon targeted'/>
        <input type='checkbox' class='fired' name='attr_beam_fired' value='1' title='weapon fired'/>
        <input type='checkbox' class='damaged' name='attr_beam_damaged' value='1' title='weapon damaged'/>
        <input type='text' class='w10' name='attr_beam_name' placeholder='# Name (arcs)...'/>
        <select class='w5' name='attr_beam_chart' title='firing chart'>
            <option value='0' selected>Chart</option>
            <option>A</option>
            <option>B</option>
            <option>C</option>
            <option>D</option>
            <option>E</option>
            <option>F</option>
            <option>G</option>
            <option>H</option>
            <option>I</option>
            <option>J</option>
            <option>K</option>
            <option>L</option>
            <option>M</option>
            <option>N</option>
            <option>O</option>
            <option>P</option>
            <option>Q</option>
            <option>R</option>
            <option>S</option>
            <option>T</option>
            <option>U</option>
            <option>V</option>
            <option>W</option>
            <option>X</option>
            <option>Y</option>
        </select>
        TPA: <input type='hidden' class='beam-power-status' name='attr_beam_power_status'/>
        <input type='number' class='beam-power' name='attr_beam_power' min='0' max='10' value='0' title='current power'/>
        /
        <input type='number' name='attr_beam_power_max' min='0' max='10' value='0' title='max power'/>
        +3: <input type='text' class='w5' name='attr_beam_bonus_3' value='-' title='+3 dmg bonus max range...'/>
        +2: <input type='text' class='w5' name='attr_beam_bonus_2' value='-' title='+2 dmg bonus max range...'/>
        +1: <input type='text' class='w5' name='attr_beam_bonus_1' value='-' title='+1 dmg bonus max range...'/>
        <button type='action' class='btn' name='act_beam-fire'>Fire</button>
    </fieldset>
    
    <h4 class='span-grid'>Missile Weapons</h4>
    <fieldset class='repeating_missiles'>
        <input type='checkbox' class='targeted' name='attr_missile_targeted' value='1' title='weapon targeted'/>
        <input type='checkbox' class='fired' name='attr_missile_fired' value='1' title='weapon fired'/>
        <input type='checkbox' class='damaged' name='attr_missile_damaged' value='1' title='weapon damaged'/>
        <input type='text' class='w10' name='attr_missile_name' placeholder='# Name (arcs)...'/>
        <select class='w5' name='attr_missile_chart' title='firing chart'>
            <option value='0' selected>Firing Chart...</option>
            <option>A</option>
            <option>B</option>
            <option>C</option>
            <option>D</option>
            <option>E</option>
            <option>F</option>
            <option>G</option>
            <option>H</option>
            <option>I</option>
            <option>J</option>
            <option>K</option>
            <option>L</option>
            <option>M</option>
            <option>N</option>
            <option>O</option>
            <option>P</option>
            <option>Q</option>
            <option>R</option>
            <option>S</option>
            <option>T</option>
            <option>U</option>
            <option>V</option>
            <option>W</option>
            <option>X</option>
            <option>Y</option>
        </select>
        TPA to arm: <input type='number' name='attr_missile_power' min='1' max='4' value='1' title='power to arm'/>
        Arm: <input type='hidden' class='missile-armed-status' name='attr_missile_armed_status'/>
        <input type='checkbox' class='missile-armed' value='1' name='attr_missile_armed' title='arm weapon'/>
        =
        <input type='number' name='attr_missile_damage' min='1' max='20' value='1' title='missile damage'/>
        <button type='action' class='btn' name='act_missile-fire'>Fire</button>
    </fieldset>
    </div>
    <hr/>

    <!-------------------------------------------------------->
    <h2>Construction Data</h2> 

    <div class='grid-3col'>
        <span>
            <label>Fleet:</label>
            <select name='attr_fleet'>
                <option selected>Select...</option>
                <option value='1'>United Federation of Planets</option>
                <option value='2'>Klingon Empire</option>
            </select>
        </span>

        <span>
            <label>Class:</label>
            <input type='text' name='attr_class' placeholder='Class...'/>
        </span>

        <span>
            <label>Type:</label>
            <input type='text' name='attr_type' placeholder='Type...'/>
        </span>

        <span>
            <label>Date Entering Service:</label>
            <input type='text' class='w10' name='attr_date' placeholder='Date...'/>
        </span>

        <span>
            <label>Number Constructed:</label>
            <input type='number' class='w7' name='attr_num' min='0'/>
        </span>

        <span>
            <label>Control Computer Type:</label>
            <input type='text' class='w7' name='attr_computer'/>
        </span>
    </div>
    <hr/>

    <!-------------------------------------------------------->
    <h2>Hull Data</h2>
    <div class='grid-6col'>
        <label>Hull Points:</label>
        <input type='number' class='w7' name='attr_hp_max' min='0' value='0'/>
        
        <label>Damage Chart:</label>
        <select class='w7' name='attr_dmg_chart'>
            <option value='0' selected>Select...</option>
            <option>A</option>
            <option>B</option>
            <option>C</option>
        </select>

        <label>Mass (mt):</label>
        <input type='number' class='w7' name='attr_mass' min='0' max='999999' value='0'/>

        <label>Length (m):</label>
        <input type='number' class='w7' name='attr_length' min='0'/>

        <label>Width (m):</label>
        <input type='number' class='w7' name='attr_width' min='0'/>
        
        <label>Height (m):</label>
        <input type='number' class='w7' name='attr_height' min='0'/>
        
        <label>Cargo Units (SCU):</label>
        <input type='number' class='w7' name='attr_scu' min='0' value='0'/>

        <label>Cargo Capacity:</label>
        <span name='attr_scu_cap'></span>

        <label>Cargo Transporters:</label>
        <input type='number' class='w7' name='attr_scu_trans' min='0' value='0'></span>
    </div>
    <hr/>

    <!-------------------------------------------------------->
    <h2>Crew Data</h2>
    <div class='grid-6col'>
        <label>Crew:</label>
        <input type='number' class='w7' name='attr_crew_max' min='0' value='0'/>
        
        <label>Passengers/Troops:</label>
        <input type='number' class='w7' name='attr_troops_max' min='0' value='0'/>

        <label>Shuttlecraft:</label>
        <input type='number' class='w7' name='attr_shuttlecraft_max' min='0' value='0'/>

        <label>Transporters:</label>
        <input type='number' class='w7' name='attr_trans_standard' min='0' value='0'/>

        <label>Combat:</label>
        <input type='number' class='w7' name='attr_trans_combat' min='0' value='0'/>

        <label>Emergency:</label>
        <input type='number' class='w7' name='attr_trans_emergency' min='0' value='0'/>

    </div>
    <hr/>

    <!-------------------------------------------------------->
    <h2>Maintenance</h2>
    <div class='grid-3col'>
        <p class='span-grid'>Do not use these controls during battle:</p>
        <button type='action' class='btn' name='act_repair'>Repair Vessel</button>
    </div>

<!-- Banner placeholders (see readme) -->
<input type='hidden' name='attr_banner_firebeam' value='[x](https://files.d20.io/images/459374797/BrLK7l69a5n4Mfomy8M4GA/original.png)'/>
<input type='hidden' name='attr_banner_firemissile' value='[x](https://files.d20.io/images/459155112/hNZ9AQX33_kJr7InoxYVbA/original.png)'/>

<script type='text/worker'>
// HELPER: Format large numbers with commas
function formatNumber(value) {
    value = value.replace(/\D/g, '');
    return value.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

// Calculate the ship's CARGO CAPACITY
on('change:scu', function(eventInfo) {
    getAttrs(['scu'], function(values) {
        const theSCU = parseInt(values['scu']) || 0;

        const theSCUCap = formatNumber(String(theSCU * 50));

        const output = {};
        output['scu_cap'] = `${theSCUCap} mt`;
        setAttrs(output);
    });
});

// Calculate the ship's COMBAT EFFICIENCY
on('change:defense change:wdf', function(eventInfo) {
    getAttrs(['defense', 'wdf'], function(values) {
        const theD = parseInt(values['defense']) || 0;
        const theWDF = parseInt(values['wdf']) || 0;

        const theCE = theD * theWDF / 100;

        const output = {};
        output['ce'] = theCE;
        setAttrs(output);
    });
});

// Calculate the MOVEMENT POINTS available
on('change:tpa_movement change:mpr_1 change:mpr_2', function(eventInfo) {
    getAttrs(['tpa_movement', 'mpr_1', 'mpr_2'], function(values) {
        const thePower = parseInt(values['tpa_movement']) || 0;
        const theRatio = (parseInt(values['mpr_1']) || 1) / (parseInt(values['mpr_2']) || 1);

        const thePoints = Math.floor(thePower / theRatio);
        const theMP01 = Math.floor(thePoints / 3) + Math.floor((thePoints % 3) / 2); // phase 1
        const theMP02 = Math.floor(thePoints / 3) + (thePoints % 3 == 1 ? 1 : 0); // phase 2
        const theMP03 = Math.floor(thePoints / 3) + Math.floor((thePoints % 3) / 2); // phase 3
        const thePowerRemaining = thePower % theRatio;

        const output = {};
        output['mp'] = thePoints;
        output['ta'] = thePoints * 100;
        output['mp1'] = theMP01;
        output['mp2'] = theMP02;
        output['mp3'] = theMP03;
        output['mp_remaining'] = thePowerRemaining;
        output['mp_remaining_status'] = thePower != 0 && (thePowerRemaining < 0 ? 1 : (thePowerRemaining > 0 ? 2 : 0));
        setAttrs(output);
    });
});

// REPAIR the vessel after combat
on('clicked:repair', function(eventInfo) {
    getSectionIDs('repeating_engines', function (ids) {
        const Fieldnames = [];
        ids.forEach(id => {
            Fieldnames.push(`repeating_engines_${id}_engine_power_max`);
        });
        
        getAttrs([...Fieldnames], function (values) {
            const output = {};
            ids.forEach(id => {
                output[`repeating_engines_${id}_engine_power`] = values[`repeating_engines_${id}_engine_power_max`];
            });
            setAttrs(output);
        });
    });

    getSectionIDs('repeating_beams', function (ids) {
        const Fieldnames = [];
        ids.forEach(id => {
            Fieldnames.push(`repeating_beams_${id}_beam_damaged`);
        });
        
        getAttrs([...Fieldnames], function (values) {
            const output = {};
            ids.forEach(id => {
                output[`repeating_beams_${id}_beam_damaged`] = 0;
            });
            setAttrs(output);
        });
    });

    getSectionIDs('repeating_missiles', function (ids) {
        const Fieldnames = [];
        ids.forEach(id => {
            Fieldnames.push(`repeating_missiles_${id}_missile-damaged`);
        });
        
        getAttrs([...Fieldnames], function (values) {
            const output = {};
            ids.forEach(id => {
                output[`repeating_missiles_${id}_missile_damaged`] = 0;
            });
            setAttrs(output);
        });
    });

    getAttrs(['hp_max', 'crew_max'], function(values) {
        const theHpMax = parseInt(values['hp_max']) || 0;
        const theCrewMax = parseInt(values['crew_max']) || 0;

        const output = {};
        output['hp'] = theHpMax;
        output['crew'] = theCrewMax;
        output['shield_1_damaged'] = 0;
        output['shield_2_damaged'] = 0;
        output['shield_3_damaged'] = 0;
        output['shield_4_damaged'] = 0;
        output['shield_5_damaged'] = 0;
        output['shield_6_damaged'] = 0;
        setAttrs(output);
    });

    resetTPA();
});

// Calculate the allocated SHIELD POINTS and TPA remaining
on('change:tpa_shields change:spr_1 change:spr_2 change:shield_1 change:shield_2 change:shield_3 change:shield_4 change:shield_5 change:shield_6', function(eventInfo) {
    getAttrs(['tpa_shields', 'spr_1', 'spr_2', 'shield_1', 'shield_2', 'shield_3', 'shield_4', 'shield_5', 'shield_6'], function(values) {
        const theTPA = parseInt(values['tpa_shields']) || 0;
        const theSPR = (parseInt(values['spr_1']) || 1) / (parseInt(values['spr_2']) || 1);
        const theShield01 = parseInt(values['shield_1']) || 0;
        const theShield02 = parseInt(values['shield_2']) || 0;
        const theShield03 = parseInt(values['shield_3']) || 0;
        const theShield04 = parseInt(values['shield_4']) || 0;
        const theShield05 = parseInt(values['shield_5']) || 0;
        const theShield06 = parseInt(values['shield_6']) || 0;

        const theSP = Math.floor(theTPA / theSPR);
        const theTPARemaining = theTPA - theShield01 * theSPR - theShield02 * theSPR - theShield03 * theSPR - theShield04 * theSPR - theShield05 * theSPR - theShield06 * theSPR;

        const output = {};
        output['sp'] = theSP;
        output['sp_remaining'] = theTPARemaining;
        output['sp_remaining_status'] = (theTPA != 0 || theTPARemaining != 0) && (theTPARemaining < 0 ? 1 : (theTPARemaining > 0 ? 2 : 0));
        setAttrs(output);
    });
});

// Update the status of SHIELD POINT, ALLOCATED
on('change:shield_1 change:shield_1_damaged change:shield_max', function(eventInfo) {
    getAttrs(['shield_1', 'shield_1_damaged', 'shield_max'], function(values) {
        const theShield = parseInt(values['shield_1']) || 0;
        const theShieldIsDamaged = parseInt(values['shield_1_damaged']) || 0;
        const theShieldMax = parseInt(values['shield_max']) || 0;

        const output = {};
        output['shield_1_status'] = theShield > theShieldMax || theShieldIsDamaged ? 1 : theShield == 0 ? 2 : 0;
        output['shield_1c'] = theShieldIsDamaged ? 0 : theShield; // When allocation changes, reset & update current
        setAttrs(output);
    });
});
on('change:shield_2 change:shield_2_damaged change:shield_max', function(eventInfo) {
    getAttrs(['shield_2', 'shield_2_damaged', 'shield_max'], function(values) {
        const theShield = parseInt(values['shield_2']) || 0;
        const theShieldIsDamaged = parseInt(values['shield_2_damaged']) || 0;
        const theShieldMax = parseInt(values['shield_max']) || 0;

        const output = {};
        output['shield_2_status'] = theShield > theShieldMax || theShieldIsDamaged ? 1 : theShield == 0 ? 2 : 0;
        output['shield_2c'] = theShieldIsDamaged ? 0 : theShield; // When allocation changes, reset & update current
        setAttrs(output);
    });
});
on('change:shield_3 change:shield_3_damaged change:shield_max', function(eventInfo) {
    getAttrs(['shield_3', 'shield_3_damaged', 'shield_max'], function(values) {
        const theShield = parseInt(values['shield_3']) || 0;
        const theShieldIsDamaged = parseInt(values['shield_3_damaged']) || 0;
        const theShieldMax = parseInt(values['shield_max']) || 0;

        const output = {};
        output['shield_3_status'] = theShield > theShieldMax || theShieldIsDamaged ? 1 : theShield == 0 ? 2 : 0;
        output['shield_3c'] = theShieldIsDamaged ? 0 : theShield; // When allocation changes, reset & update current
        setAttrs(output);
    });
});
on('change:shield_4 change:shield_4_damaged change:shield_max', function(eventInfo) {
    getAttrs(['shield_4', 'shield_4_damaged', 'shield_max'], function(values) {
        const theShield = parseInt(values['shield_4']) || 0;
        const theShieldIsDamaged = parseInt(values['shield_4_damaged']) || 0;
        const theShieldMax = parseInt(values['shield_max']) || 0;

        const output = {};
        output['shield_4_status'] = theShield > theShieldMax || theShieldIsDamaged ? 1 : theShield == 0 ? 2 : 0;
        output['shield_4c'] = theShieldIsDamaged ? 0 : theShieldIsDamaged ? 0 : theShield; // When allocation changes, reset & update current
        setAttrs(output);
    });
});
on('change:shield_5 change:shield_5_damaged change:shield_max', function(eventInfo) {
    getAttrs(['shield_5', 'shield_5_damaged', 'shield_max'], function(values) {
        const theShield = parseInt(values['shield_5']) || 0;
        const theShieldIsDamaged = parseInt(values['shield_5_damaged']) || 0;
        const theShieldMax = parseInt(values['shield_max']) || 0;

        const output = {};
        output['shield_5_status'] = theShield > theShieldMax || theShieldIsDamaged ? 1 : theShield == 0 ? 2 : 0;
        output['shield_5c'] = theShieldIsDamaged ? 0 : theShield; // When allocation changes, reset & update current
        setAttrs(output);
    });
});
on('change:shield_6 change:shield_6_damaged change:shield_max', function(eventInfo) {
    getAttrs(['shield_6', 'shield_6_damaged', 'shield_max'], function(values) {
        const theShield = parseInt(values['shield_6']) || 0;
        const theShieldIsDamaged = parseInt(values['shield_6_damaged']) || 0;
        const theShieldMax = parseInt(values['shield_max']) || 0;

        const output = {};
        output['shield_6_status'] = theShield > theShieldMax || theShieldIsDamaged ? 1 : theShield == 0 ? 2 : 0;
        output['shield_6c'] = theShieldIsDamaged ? 0 : theShield; // When allocation changes, reset & update current
        setAttrs(output);
    });
});

// Update the status of SHIELD POINTS, CURRENT
on('change:shield_1c', function(eventInfo) {
    getAttrs(['shield_1', 'shield_1c'], function(values) {
        const theShield = parseInt(values['shield_1']) || 0;
        const theShieldCurrent = parseInt(values['shield_1c']) || 0;

        const output = {};
        output['shield_1c_status'] = theShieldCurrent > theShield || theShieldCurrent == 0 ? 1 : theShieldCurrent == theShield ? 0 : 2;
        setAttrs(output);
    });
});
on('change:shield_2c', function(eventInfo) {
    getAttrs(['shield_2', 'shield_2c'], function(values) {
        const theShield = parseInt(values['shield_2']) || 0;
        const theShieldCurrent = parseInt(values['shield_2c']) || 0;

        const output = {};
        output['shield_2c_status'] = theShieldCurrent > theShield || theShieldCurrent == 0 ? 1 : theShieldCurrent == theShield ? 0 : 2;
        setAttrs(output);
    });
});
on('change:shield_3c', function(eventInfo) {
    getAttrs(['shield_3', 'shield_3c'], function(values) {
        const theShield = parseInt(values['shield_3']) || 0;
        const theShieldCurrent = parseInt(values['shield_3c']) || 0;

        const output = {};
        output['shield_3c_status'] = theShieldCurrent > theShield || theShieldCurrent == 0 ? 1 : theShieldCurrent == theShield ? 0 : 2;
        setAttrs(output);
    });
});
on('change:shield_4c', function(eventInfo) {
    getAttrs(['shield_4', 'shield_4c'], function(values) {
        const theShield = parseInt(values['shield_4']) || 0;
        const theShieldCurrent = parseInt(values['shield_4c']) || 0;

        const output = {};
        output['shield_4c_status'] = theShieldCurrent > theShield || theShieldCurrent == 0 ? 1 : theShieldCurrent == theShield ? 0 : 2;
        setAttrs(output);
    });
});
on('change:shield_5c', function(eventInfo) {
    getAttrs(['shield_5', 'shield_5c'], function(values) {
        const theShield = parseInt(values['shield_5']) || 0;
        const theShieldCurrent = parseInt(values['shield_5c']) || 0;

        const output = {};
        output['shield_5c_status'] = theShieldCurrent > theShield || theShieldCurrent == 0 ? 1 : theShieldCurrent == theShield ? 0 : 2;
        setAttrs(output);
    });
});
on('change:shield_6c', function(eventInfo) {
    getAttrs(['shield_6', 'shield_6c'], function(values) {
        const theShield = parseInt(values['shield_6']) || 0;
        const theShieldCurrent = parseInt(values['shield_6c']) || 0;

        const output = {};
        output['shield_6c_status'] = theShieldCurrent > theShield || theShieldCurrent == 0 ? 1 : theShieldCurrent == theShield ? 0 : 2;
        setAttrs(output);
    });
});

// Commit TPA to SHIELDS (switch from allocation to energized)
on('clicked:shield_commit', function(eventInfo) {
    const output = {};
    output['shields_allocated_status'] = 0;
    output['shields_current_status'] = 1;
    setAttrs(output);
});


// Re-energize SHIELDS
on('clicked:shield_reenergize', function(eventInfo) {
    getAttrs(['shield_1', 'shield_2', 'shield_3', 'shield_4', 'shield_5', 'shield_6', 'shield_1_damaged', 'shield_2_damaged', 'shield_3_damaged', 'shield_4_damaged', 'shield_5_damaged', 'shield_6_damaged'], function(values) {
        const theShield01 = parseInt(values['shield_1']) || 0;
        const theShield02 = parseInt(values['shield_2']) || 0;
        const theShield03 = parseInt(values['shield_3']) || 0;
        const theShield04 = parseInt(values['shield_4']) || 0;
        const theShield05 = parseInt(values['shield_5']) || 0;
        const theShield06 = parseInt(values['shield_6']) || 0;
        const theShield01IsDamaged = parseInt(values['shield_1_damaged']) || 0;
        const theShield02IsDamaged = parseInt(values['shield_2_damaged']) || 0;
        const theShield03IsDamaged = parseInt(values['shield_3_damaged']) || 0;
        const theShield04IsDamaged = parseInt(values['shield_4_damaged']) || 0;
        const theShield05IsDamaged = parseInt(values['shield_5_damaged']) || 0;
        const theShield06IsDamaged = parseInt(values['shield_6_damaged']) || 0;

        const output = {};
        output['shield_1c'] = theShield01IsDamaged ? 0 : theShield01;
        output['shield_2c'] = theShield02IsDamaged ? 0 : theShield02;
        output['shield_3c'] = theShield03IsDamaged ? 0 : theShield03;
        output['shield_4c'] = theShield04IsDamaged ? 0 : theShield04;
        output['shield_5c'] = theShield05IsDamaged ? 0 : theShield05;
        output['shield_6c'] = theShield06IsDamaged ? 0 : theShield06;
        setAttrs(output);
    });
});

// Format the ship's mass and display SIZE class
on('change:mass', function(eventInfo) {
    getAttrs(['mass'], function(values) {
        const theMass = parseInt(values['mass']) || 0;
        const theFormattedMass = formatNumber(String(theMass));

        const theSizes = [0,'I',5000,'II',15000,'III',25000,'IV',40000,'V',60000,'VI',80000,'VII',100000,'VIII',120000,'IX',140000,'X',160000,'XI',180000,'XII',210000,'XIII',240000,'XIV',300000,'XV',350000,'XVI',400000,'XVII',450000,'XVIII',500000,'XIX',600000,'XX',700000];
        let i = 0;
        do {
            i += 2;
        } while (theMass > theSizes[i]);      

        const output = {};
        output['size'] = `${theFormattedMass} mt (${theSizes[i-1]})`;
        setAttrs(output);
    });
});

// Update ship's current SUPERSTRUCTURE status
on('change:hp', function(eventInfo) {
    getAttrs(['hp', 'hp_max'], function(values) {
        const theHP = parseInt(values['hp']) || 0;  
        const theHPMax = parseInt(values['hp_max']) || 0;  

        const output = {};
        output['hp_status'] = theHP < (theHPMax / 2) || theHP > theHPMax ? 1 : theHP < theHPMax ? 2 : 0;
        setAttrs(output);
    });
});

// Calculate the ship's TPA values
on('change:repeating_engines:engine_power change:repeating_engines:engine_power_max remove:repeating_engines', function(eventInfo) {
    getSectionIDs('repeating_engines', function (ids) {
        const Fieldnames = [];
        ids.forEach(id => {
            Fieldnames.push(`repeating_engines_${id}_engine_power`);
            Fieldnames.push(`repeating_engines_${id}_engine_power_max`);
        });
        
        getAttrs([...Fieldnames], function (values) {
            let theTPA = 0;
            let theTPAMax = 0;
            const output = {};
            ids.forEach(id => {
                const theEnginePower = parseFloat(values[`repeating_engines_${id}_engine_power`]) || 0;
                const theEnginePowerMax = parseFloat(values[`repeating_engines_${id}_engine_power_max`]) || 0;
                
                theTPA += theEnginePower;
                theTPAMax += theEnginePowerMax

                output[`repeating_engines_${id}_engine_power_status`] = ((theEnginePower > theEnginePowerMax) || (theEnginePower == 0)) ? 1 : theEnginePower < theEnginePowerMax ? 2 : 0;
            });
            output['tpa'] = theTPA;
            output['tpa_max'] = theTPAMax;
            setAttrs(output);
        });
    });
});

// Calculate the ship's TPA remaining
on('change:tpa change:tpa_movement change:tpa_weapons change:tpa_shields', function(eventInfo) {
    getAttrs(['tpa', 'tpa_movement', 'tpa_weapons', 'tpa_shields'], function(values) {
        const theTPA = parseInt(values['tpa']) || 0;
        const theTPAMovement = parseInt(values['tpa_movement']) || 0;
        const theTPAWeapons = parseInt(values['tpa_weapons']) || 0;
        const theTPAShields = parseInt(values['tpa_shields']) || 0;

        const theTPARemaining = theTPA - theTPAMovement - theTPAWeapons - theTPAShields;

        const output = {};
        output['tpa_remaining'] = theTPARemaining;
        output['tpa_remaining_status'] = (theTPARemaining < 0 ? 1 : (theTPARemaining > 0 ? 2 : 0));
        setAttrs(output);
    });
});

// Reset the vessel's TPA allocation.
on('clicked:tpa_reset', function(eventInfo) {
    resetTPA();
});
function resetTPA() {
    getSectionIDs('repeating_beams', function (ids) {
        const Fieldnames = [];
        ids.forEach(id => {
            Fieldnames.push(`repeating_beams_${id}_beam_targeted`);
        });
        
        getAttrs([...Fieldnames], function (values) {
            const output = {};
            ids.forEach(id => {
                output[`repeating_beams_${id}_beam_targeted`] = 0;
                output[`repeating_beams_${id}_beam_fired`] = 0;
                output[`repeating_beams_${id}_beam_power`] = 0;
            });
            output['wp_beam'] = 0;
            setAttrs(output);
        });
    });

    getSectionIDs('repeating_missiles', function (ids) {
        const Fieldnames = [];
        ids.forEach(id => {
            Fieldnames.push(`repeating_missiles_${id}_missile-armed`);
        });
        
        getAttrs([...Fieldnames], function (values) {
            const output = {};
            ids.forEach(id => {
                output[`repeating_missiles_${id}_missile_targeted`] = 0;
                output[`repeating_missiles_${id}_missile_fired`] = 0;
                output[`repeating_missiles_${id}_missile_armed`] = 0;
            });
            output['wp_missile'] = 0;
            setAttrs(output);
        });
    });

    const output = {};
    output['shield_1'] = output['shield_2'] = output['shield_3'] = output['shield_4'] = output['shield_5'] = output['shield_6'] = 0
    output['shields_allocated_status'] = 1;
    output['shields_current_status'] = 0;
    output['tpa_movement'] = 0;
    output['tpa_weapons'] = 0;
    output['tpa_shields'] = 0;
    setAttrs(output);
}

// Calculate the WEAPONS TPA remaining
on('change:tpa_weapons change:wp_beam change:wp_missile', function(eventInfo) {
    getAttrs(['tpa_weapons', 'wp_beam', 'wp_missile'], function(values) {
        const theTPA = parseInt(values['tpa_weapons']) || 0;
        const theBeamTPA = parseInt(values['wp_beam']) || 0;
        const theMissileTPA = parseInt(values['wp_missile']) || 0;

        const theTPARemaining = theTPA - theBeamTPA - theMissileTPA;

        const output = {};
        output['wp_remaining'] = theTPARemaining;
        output['wp_remaining_status'] = (theTPA != 0 || theTPARemaining != 0) && (theTPARemaining < 0 ? 1 : (theTPARemaining > 0 ? 2 : 0));
        setAttrs(output);
    });
});

// Ensure a DAMAGED WEAPON cannot be TARGETED
on('change:repeating_beams:beam_targeted', function(eventInfo) {
    getAttrs(['repeating_beams_beam_targeted', 'repeating_beams_beam_damaged', 'repeating_beams_beam_power'], function(values) {
        const theBeamIsTargeted = parseInt(values['repeating_beams_beam_targeted']) || 0;
        const theBeamIsDamaged = parseInt(values['repeating_beams_beam_damaged']) || 0;
        const theBeamIsPowered = parseInt(values['repeating_beams_beam_power']) || 0;

        if ((theBeamIsTargeted == 1 && theBeamIsDamaged) || 
        (theBeamIsTargeted && !theBeamIsPowered)) {
            const output = {};
            output['repeating_beams_beam_targeted'] = 0;
            setAttrs(output);
        }
    });
});
on('change:repeating_missiles:missile_targeted', function(eventInfo) {
    getAttrs(['repeating_missiles_missile_targeted', 'repeating_missiles_missile_damaged', 'repeating_missiles_missile_armed'], function(values) {
        const theMissileIsTargeted = parseInt(values['repeating_missiles_missile_targeted']) || 0;
        const theMissileIsDamaged = parseInt(values['repeating_missiles_missile_damaged']) || 0;
        const theMissileIsArmed = parseInt(values['repeating_missiles_missile_armed']) || 0;

        if ((theMissileIsTargeted == 1 && theMissileIsDamaged) || 
        (theMissileIsTargeted && !theMissileIsArmed)) {
            const output = {};
            output['repeating_missiles_missile_targeted'] = 0;
            setAttrs(output);
        }
    });
});

// Fire a beam WEAPON
on('clicked:repeating_beams:beam-fire', () => {
    getAttrs(['repeating_beams_beam_bonus_1', 'repeating_beams_beam_bonus_2', 'repeating_beams_beam_bonus_3', 'repeating_beams_beam_damaged', 'repeating_beams_beam_fired', 'repeating_beams_beam_name', 'repeating_beams_beam_power', 'repeating_beams_beam_targeted'], function(values) {
        const theBonus01 = values['repeating_beams_beam_bonus_1'];
        const theBonus02 = values['repeating_beams_beam_bonus_2'];
        const theBonus03 = values['repeating_beams_beam_bonus_3'];
        const theWeaponIsDamaged = parseInt(values['repeating_beams_beam_damaged']) || 0;
        const theWeaponIsPowered = parseInt(values['repeating_beams_beam_power']) ||0;
        const theWeaponWasAlreadyFired = parseInt(values['repeating_beams_beam_fired']) || 0;
        const theWeaponName = values['repeating_beams_beam_name'];
        const theWeaponIsTargeted = parseInt(values['repeating_beams_beam_targeted']) || 0;

        const output = {};

        if (theWeaponIsDamaged && !theWeaponIsTargeted) {
            startRoll(`&{template:custom} {{title=**@{character_name}**}} {{subtitle=Beam Weapon Attack}} {{Weapon=${theWeaponName}}} {{Error=**Weapon Is Damaged**}}`, roll => {
              finishRoll(roll.rollId);
            });
        } else if (!theWeaponIsPowered) {
            startRoll(`&{template:custom} {{title=**@{character_name}**}} {{subtitle=Beam Weapon Attack}} {{Weapon=${theWeaponName}}} {{Error=**Weapon Not Charged**}}`, roll => {
              finishRoll(roll.rollId);
            });
        } else if (theWeaponWasAlreadyFired) {
            startRoll(`&{template:custom} {{title=**@{character_name}**}} {{subtitle=Beam Weapon Attack}} {{Weapon=${theWeaponName}}} {{Error=**Weapon Already Fired**}}`, roll => {
              finishRoll(roll.rollId);
            }); 
        } else if (!theWeaponIsTargeted) {
            startRoll(`&{template:custom} {{title=**@{character_name}**}} {{subtitle=Beam Weapon Attack}} {{Weapon=${theWeaponName}}} {{Error=**Weapon Not Targetted**}}`, roll => {
              finishRoll(roll.rollId);
            });             
        } else {
            startRoll(`&{template:custom} {{color=red}} {{title=@{banner_firebeam} **@{character_name}**}} {{subtitle=Beam Weapon Attack}} {{Weapon=${theWeaponName}}} {{Power/Damage=${theWeaponIsPowered}}} {{+3 dmg @ ranges=${theBonus03}}} {{+2 dmg @ ranges=${theBonus02}}} {{+1 dmg @ ranges=${theBonus01}}} {{Target=@{target|Target|character_name}}} {{@ Range=?{Range?|24}}} {{To-Hit=[[?{To-Hit?|1}]] or less}} {{Roll=[[1d10cs>11cf<0]]}} {{Location=[[1t[DLBasic]]]}}`, roll => {
              finishRoll(roll.rollId);
            });
            output['repeating_beams_beam_fired'] = 1;
        }

        setAttrs(output); 
    });
});

// Fire a missile WEAPON
on('clicked:repeating_missiles:missile-fire', () => {
    getAttrs(['repeating_missiles_missile_armed', 'repeating_missiles_missile_damage', 'repeating_missiles_missile_damaged', 'repeating_missiles_missile_fired', 'repeating_missiles_missile_name', 'repeating_missiles_missile_targeted'], function(values) {
        const theWeaponDamaged = parseInt(values['repeating_missiles_missile_damaged']) || 0;
        const theWeaponArmed = parseInt(values['repeating_missiles_missile_armed']) ||0;
        const theDamage = parseInt(values['repeating_missiles_missile_damage']) ||0;
        const theWeaponFired = parseInt(values['repeating_missiles_missile_fired']) || 0;
        const theWeaponName = values['repeating_missiles_missile_name'];
        const theWeaponTargeted = parseInt(values['repeating_missiles_missile_targeted']) || 0;

        const output = {};

        if (theWeaponDamaged == 1) {
            startRoll(`&{template:custom} {{title=**@{character_name}**}} {{subtitle=Missile Weapon Attack}} {{Weapon=${theWeaponName}}} {{Error=**Weapon Is Damaged**}}`, roll => {
              finishRoll(roll.rollId);
            });
        } else if (theWeaponArmed == 0) {
            startRoll(`&{template:custom} {{title=**@{character_name}**}} {{subtitle=Missile Weapon Attack}} {{Weapon=${theWeaponName}}} {{Error=**Weapon Not Armed**}}`, roll => {
              finishRoll(roll.rollId);
            });
        } else if (theWeaponFired == 1) {
            startRoll(`&{template:custom} {{title=**@{character_name}**}} {{subtitle=Missile Weapon Attack}} {{Weapon=${theWeaponName}}} {{Error=**Weapon Already Fired**}}`, roll => {
              finishRoll(roll.rollId);
            }); 
        } else if (theWeaponTargeted == 0) {
            startRoll(`&{template:custom} {{title=**@{character_name}**}} {{subtitle=Missile Weapon Attack}} {{Weapon=${theWeaponName}}} {{Error=**Weapon Not Targetted**}}`, roll => {
              finishRoll(roll.rollId);
            });             
        } else {
            startRoll(`&{template:custom} {{color=red}} {{title=@{banner_firemissile} **@{character_name}**}} {{subtitle=Missile Weapon Attack}} {{Weapon=${theWeaponName}}} {{Damage=${theDamage}}} {{Target=@{target|Target|character_name}}} {{@ Range=?{Range?|24}}} {{To-Hit=[[?{To-Hit?|1}]] or less}} {{Roll=[[1d10cs>11cf<0]]}} {{Location=[[1t[DLBasic]]]}}`, roll => {
              finishRoll(roll.rollId);
            });
            output['repeating_missiles_missile_fired'] = 1;
        }

        setAttrs(output); 
    });
});

// Calculate the power allocated to WEAPONS, BEAM
on('change:repeating_beams:beam_damaged change:repeating_beams:beam_power change:repeating_beams:beam_power_max remove:repeating_beams', function(eventInfo) {
    getSectionIDs('repeating_beams', function (ids) {
        const Fieldnames = [];
        ids.forEach(id => {
            Fieldnames.push(`repeating_beams_${id}_beam_damaged`);
            Fieldnames.push(`repeating_beams_${id}_beam_power`);
            Fieldnames.push(`repeating_beams_${id}_beam_power_max`);
        });
        
        getAttrs([...Fieldnames], function (values) {
            let totalPowerToBeams = 0;
            const output = {};
            ids.forEach(id => {
                const theBeamIsDamaged = parseInt(values[`repeating_beams_${id}_beam_damaged`]) || 0;
                const theBeamPower = parseInt(values[`repeating_beams_${id}_beam_power`]) || 0;
                const theBeamPowerMax = parseInt(values[`repeating_beams_${id}_beam_power_max`]) || 0;
                totalPowerToBeams += theBeamIsDamaged == 0 ? theBeamPower : 0;

                output[`repeating_beams_${id}_beam_power_status`] = theBeamIsDamaged == 1 ? 1 : (theBeamPowerMax - theBeamPower) < 0 ? 1 : (theBeamPower > 0 ? 2 : 0);
            });
            output['wp_beam'] = totalPowerToBeams;
            setAttrs(output);
        });
    });
});

// Calculate the power allocated to WEAPONS, MISSILE
on('change:repeating_missiles:missile_damaged change:repeating_missiles:missile_armed change:repeating_missiles:missile_power remove:repeating_missiles', function(eventInfo) {
    getSectionIDs('repeating_missiles', function (ids) {
        const Fieldnames = [];
        ids.forEach(id => {
            Fieldnames.push(`repeating_missiles_${id}_missile_damaged`);
            Fieldnames.push(`repeating_missiles_${id}_missile_armed`);
            Fieldnames.push(`repeating_missiles_${id}_missile_power`);
        });
        
        getAttrs([...Fieldnames], function (values) {
            let totalPowerToMissiles = 0;
            const output = {};
            ids.forEach(id => {
                const theMissileIsDamaged = parseInt(values[`repeating_missiles_${id}_missile_damaged`]) || 0;
                const theMissilePower = (parseInt(values[`repeating_missiles_${id}_missile_armed`]) || 0) * (parseInt(values[`repeating_missiles_${id}_missile_power`]) || 0);
                totalPowerToMissiles += theMissileIsDamaged == 0 ? theMissilePower : 0;

                output[`repeating_missiles_${id}_missile_armed_status`] = theMissileIsDamaged == 1 ? 1 : 0;
            });
            output['wp_missile'] = totalPowerToMissiles;
            setAttrs(output);
        });
    });
});

</script>

<rolltemplate class="sheet-rolltemplate-custom">
    <div class="sheet-container sheet-color-{{color}}">
      <div class="sheet-header">
        {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
        {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
      </div>

      <div class="sheet-content">
        {{#allprops() title subtitle color Location}}
        <div class="sheet-key">{{key}}</div>
        <div class="sheet-value">{{value}}</div>
        {{/allprops() title subtitle color Location}}

        {{#^rollGreater() Roll To-Hit}}
        <div class="sheet-key">Result</div>
        <div class="sheet-value"><span class="success">Hit!</span></div>
        {{#Location}}
            <div class="sheet-key">Location</div>
            <div class="sheet-value">{{Location}}</div>
        {{/Location}}
        {{/^rollGreater() Roll To-Hit}}

        {{#rollGreater() Roll To-Hit}}
        <div class="sheet-key">Result</div>
        <div class="sheet-value"><span class="failure">Miss!</span></div>
        {{/rollGreater() Roll To-Hit}}

        {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
      </div>
    </div>
</rolltemplate>


<rolltemplate class="sheet-rolltemplate-menu">
    <div class="sheet-container sheet-color-{{color}}">
         <div class="sheet-header">
            {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
            {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
        </div>
         <div class="sheet-content">
            {{#allprops() title subtitle desc color}}
                <div class="sheet-key">{{key}}</div>
                <div class="sheet-value">{{value}}</div>
            {{/allprops() title subtitle desc color}}
            {{#desc}}
                <div class="sheet-desc">{{desc}}</div>
            {{/desc}}
        </div>
    </div>
</rolltemplate>